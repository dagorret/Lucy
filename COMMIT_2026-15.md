# Commit 2026-15: Mejoras Mayores en PyLucy

## ðŸ“¦ Archivos Agregados/Modificados

### âœ… Nuevos Archivos (10)
```
src/alumnos/
â”œâ”€â”€ FILTROS_ADMIN.md                    - DocumentaciÃ³n de filtros admin
â”œâ”€â”€ verificar_filtros.py                - Script de verificaciÃ³n
â””â”€â”€ tasks/                              - MÃ³dulo de tareas (NUEVO)
    â”œâ”€â”€ __init__.py                     - Exporta todas las tareas
    â”œâ”€â”€ README.md                       - DocumentaciÃ³n del mÃ³dulo
    â”œâ”€â”€ FLUJO_AUTOMATICO.md            - Diagramas de flujo
    â”œâ”€â”€ ingesta.py                      - Tareas de ingesta SIAL
    â”œâ”€â”€ teams.py                        - Tareas de Microsoft Teams
    â”œâ”€â”€ moodle.py                       - Tareas de Moodle
    â”œâ”€â”€ procesamiento.py                - Procesamiento de cola
    â”œâ”€â”€ helpers.py                      - Funciones auxiliares
    â””â”€â”€ personalizadas.py               - Tareas personalizadas
```

### ðŸ”§ Archivos Modificados (2)
```
src/alumnos/
â”œâ”€â”€ admin.py                            - Filtros Teams/Moodle/Email
â””â”€â”€ services/
    â””â”€â”€ email_service.py                - Plantillas HTML FCE-UNRC
```

---

## ðŸŽ¯ Cambios Principales

### 1. Plantillas HTML para Emails
**Archivo:** `src/alumnos/services/email_service.py`

Reemplazadas todas las plantillas de email con diseÃ±o institucional FCE-UNRC:
- âœ… Email de bienvenida (diseÃ±o responsivo)
- âœ… Email de credenciales Teams (con advertencias de seguridad)
- âœ… Email de enrollamiento Moodle (con instrucciones de acceso)
- âœ… Email de password reset (con avisos importantes)

**CaracterÃ­sticas:**
- Colores institucionales (#0b2f5b)
- Estructura HTML completa con estilos inline
- Responsive design
- InformaciÃ³n de contacto (v.estudiantes@fce.unrc.edu.ar, ChatBOT)

---

### 2. Filtros AutomÃ¡ticos en Admin
**Archivo:** `src/alumnos/admin.py`

Agregados 3 filtros personalizados en la barra lateral:

**Filtro Estado Teams:**
- Con Teams (tiene email institucional)
- Sin Teams (sin email institucional)

**Filtro Estado Moodle:**
- Con Moodle (tiene cursos)
- Sin Moodle (sin cursos)

**Filtro Estado Email:**
- Con email personal
- Con email institucional
- Con cualquier email
- Sin email

**DocumentaciÃ³n:** `src/alumnos/FILTROS_ADMIN.md`
**VerificaciÃ³n:** `python manage.py shell < src/alumnos/verificar_filtros.py`

---

### 3. DivisiÃ³n de tasks.py
**UbicaciÃ³n:** `src/alumnos/tasks/`

Dividido archivo monolÃ­tico de 2,623 lÃ­neas en 7 mÃ³dulos especializados:

| MÃ³dulo | LÃ­neas | Contenido |
|--------|--------|-----------|
| `ingesta.py` | 758 | Ingesta automÃ¡tica desde SIAL/UTI |
| `teams.py` | 371 | Tareas de Microsoft Teams/Graph API |
| `moodle.py` | 159 | Enrollamiento en Moodle |
| `procesamiento.py` | 484 | Cola de procesamiento con rate limits |
| `helpers.py` | 595 | Funciones auxiliares compartidas |
| `personalizadas.py` | 300 | Tareas personalizadas del usuario |
| `__init__.py` | 107 | Exporta todas (compatibilidad) |

**Total:** 2,774 lÃ­neas (+151 por headers MIT)

**Compatibilidad:**
```python
# Imports antiguos siguen funcionando
from alumnos.tasks import ingestar_preinscriptos
from alumnos.tasks import procesar_cola_tareas_pendientes

# Imports nuevos tambiÃ©n funcionan
from alumnos.tasks.ingesta import ingestar_preinscriptos
from alumnos.tasks.procesamiento import procesar_cola_tareas_pendientes
```

**DocumentaciÃ³n:**
- `src/alumnos/tasks/README.md` - Estructura y distribuciÃ³n
- `src/alumnos/tasks/FLUJO_AUTOMATICO.md` - Diagramas de flujo completos

---

## ðŸ”„ Workflow AutomÃ¡tico

### Celery Beat (cada 5 minutos)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CELERY BEAT                            â”‚
â”‚  Crontab: */5 * * * *                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â–º ingestar_preinscriptos()
           â”œâ”€â”€â–º ingestar_aspirantes()
           â”œâ”€â”€â–º ingestar_ingresantes()
           â””â”€â”€â–º procesar_cola_tareas_pendientes()
```

### Workflow por CategorÃ­a

**PREINSCRIPTOS:**
- âœ… Email de bienvenida (si configurado)
- âŒ NO se crea Teams
- âŒ NO se enrolla en Moodle

**ASPIRANTES/INGRESANTES:**
- âœ… Email de bienvenida (inmediato)
- âœ… Tarea CREAR_USUARIO_TEAMS â†’ Email credenciales (cola, max 5 min)
- âœ… Tarea MOODLE_ENROLL â†’ Email enrollamiento (cola, max 5 min)

### Rate Limits Aplicados
- `rate_limit_teams`: Tareas/min para Graph API
- `rate_limit_moodle`: Tareas/min para Moodle Web Services
- `rate_limit_uti`: Tareas/min para API UTI/SIAL
- `batch_size`: MÃ¡ximo de tareas por ejecuciÃ³n

ImplementaciÃ³n: `src/alumnos/tasks/procesamiento.py:120-141`

---

## ðŸ“Š EstadÃ­sticas del Commit

```
13 archivos modificados
3,963 inserciones(+)
133 eliminaciones(-)

Nuevos archivos: 10
Modificados: 2
Respaldo: 1 (tasks.py.bak)
```

---

## ðŸ§ª VerificaciÃ³n

### 1. CompilaciÃ³n
```bash
python3 -m py_compile src/alumnos/admin.py
python3 -m py_compile src/alumnos/tasks/*.py
```

### 2. Filtros en Admin
```bash
python manage.py shell < src/alumnos/verificar_filtros.py
```

### 3. Imports de Tasks
```bash
python manage.py shell -c "from alumnos.tasks import ingestar_preinscriptos, procesar_cola_tareas_pendientes; print('âœ… OK')"
```

---

## ðŸ“š DocumentaciÃ³n Incluida

1. **FILTROS_ADMIN.md** - GuÃ­a completa de uso de filtros
   - Casos de uso por rol
   - Ejemplos de combinaciones
   - Queries SQL equivalentes

2. **tasks/README.md** - Estructura de mÃ³dulos de tareas
   - DistribuciÃ³n de funciones
   - EstadÃ­sticas de lÃ­neas
   - GuÃ­a de imports

3. **tasks/FLUJO_AUTOMATICO.md** - Diagramas de flujo
   - Celery Beat schedule
   - Workflow de ingesta
   - Procesamiento de cola
   - Ejemplos de ejecuciÃ³n

---

**Fecha:** 2025-12-29  
**Autor:** Carlos Dagorret  
**Licencia:** MIT
